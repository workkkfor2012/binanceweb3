è¿™æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„åŠŸèƒ½å‡çº§ï¼åˆ©ç”¨ migrateTime - createTimeï¼ˆå³ Bonding Curve å¡«æ»¡è€—æ—¶ï¼‰ç¡®å®æ˜¯åˆ¤æ–­ Meme ä»£å¸â€œçˆ†å‘åŠ›â€å’Œâ€œåº„å®¶å®åŠ›â€çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚

æ ¹æ®ä½ çš„éœ€æ±‚å’Œæä¾›çš„æ•°æ®å­—æ®µï¼Œæˆ‘å·²ç»é‡æ–°æ„å»ºäº†å‰ç«¯ä»£ç ã€‚

ä¿®æ”¹é‡ç‚¹ï¼š

ğŸ”¥ é‡‘ç‹—é›·è¾¾ (Bonding Speed): è®¡ç®—å‘å°„è€—æ—¶ã€‚

< 30åˆ†é’Ÿ: æ˜¾ç¤º ğŸ”¥ ç«ç„°å›¾æ ‡ï¼ˆæé€Ÿ/å¼ºåº„ï¼‰ã€‚

< 2å°æ—¶: æ˜¾ç¤º âš¡ é—ªç”µå›¾æ ‡ï¼ˆå¿«é€Ÿï¼‰ã€‚

> 24å°æ—¶: æ˜¾ç¤º ğŸ¢ ä¹Œé¾Ÿå›¾æ ‡ï¼ˆç£¨ç›˜ï¼‰ã€‚

ğŸ’° æ°ªé‡‘æ ‡è®° (AD): åˆ©ç”¨ paidOnDexScreener å­—æ®µï¼Œç»™ä»˜è´¹ä»£å¸æ‰“ä¸Šé‡‘è‰² "AD" æ ‡ç­¾ã€‚

ğŸ¯ é£é™©é¢„è­¦ (Sniper): åˆ©ç”¨ holdersSniperPercentï¼Œå¦‚æœç‹™å‡»æ‰‹å æ¯”è¿‡é«˜ (>50%)ï¼Œæ˜¾ç¤ºçº¢è‰²è­¦å‘Šã€‚

ğŸ“Š ä¹°å–æƒ…ç»ª: ç›´æ¥å±•ç¤º countBuy / countSellï¼Œç›´è§‚çœ‹åˆ°ä¹°ç›˜æ˜¯å¦å¼ºåŠ²ã€‚


// packages/frontend/src/MemePage.tsx
import { Component, createMemo, For, Show, onMount, createSignal, createEffect } from 'solid-js';
import { useMarketData } from './hooks/useMarketData';
import type { MemeItem } from './types';


const BACKEND_URL = 'http://localhost:3001';

declare global {
    interface Window {
        twttr: any;
    }
}

interface MemeCardProps {
    item: MemeItem;
}

interface ColumnProps {
    title: string;
    items: MemeItem[];
    count: number;
}

// ID æå– (æ”¯æŒ x.com å’Œ twitter.com)
const extractTweetId = (input: string | undefined | null): string | null => {
    if (!input) return null;
    const str = String(input).trim();
    if (/^\d+$/.test(str)) return str;
    const match = str.match(/status\/(\d+)/);
    if (match && match[1]) return match[1];
    return null;
};

const formatTime = (ts: number | undefined) => {
    if (!ts) return '';
    return new Date(ts).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
};

// âœ¨ æ ¸å¿ƒé€»è¾‘ï¼šè®¡ç®—â€œå‘å°„è€—æ—¶â€ (Bonding Speed)
// é€»è¾‘ï¼šè¿ç§»æ—¶é—´ - åˆ›å»ºæ—¶é—´ = å¡«æ»¡æ›²çº¿è€—æ—¶
const getBondingDuration = (item: MemeItem): { text: string; color: string; icon: string } | null => {
    // å¿…é¡»ä¸¤ä¸ªæ—¶é—´éƒ½æœ‰ä¸”æœ‰æ•ˆ
    if (!item.migrateTime || !item.createTime || item.migrateTime <= 0 || item.createTime <= 0) return null;
    
    // å¦‚æœ migrateTime æ¯” createTime è¿˜å°ï¼ˆæç«¯æ•°æ®å¼‚å¸¸ï¼‰ï¼Œåˆ™ä¸æ˜¾ç¤º
    if (item.migrateTime < item.createTime) return null;

    const diffMs = item.migrateTime - item.createTime;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMins / 60);

    // ğŸš€ æé€Ÿé‡‘ç‹—ï¼šå°äº 30 åˆ†é’Ÿ (Strong Bullish)
    if (diffMins < 30) {
        return { text: `${diffMins}m`, color: '#dc3545', icon: 'ğŸ”¥' }; // Red Fire
    }
    // âš¡ å¿«é€Ÿï¼šå°äº 2 å°æ—¶
    if (diffHours < 2) {
        return { text: `${diffMins}m`, color: '#fd7e14', icon: 'âš¡' }; // Orange Bolt
    }
    // â± æ™®é€šï¼šå°äº 24 å°æ—¶
    if (diffHours < 24) {
        return { text: `${diffHours}h`, color: '#6c757d', icon: 'â±' }; // Gray
    }
    // ğŸ¢ é¾Ÿé€Ÿ
    return { text: '>1d', color: '#6c757d', icon: 'ğŸ¢' };
};

// --- æ¨ç‰¹ç»„ä»¶ ---
const TweetEmbed: Component<{ tweetId: string; }> = (props) => {
    let containerRef: HTMLDivElement | undefined;
    const [isLoaded, setIsLoaded] = createSignal(false);

    onMount(() => {
        if (!props.tweetId) return;

        if (!window.twttr) {
            const script = document.createElement('script');
            script.src = 'https://platform.twitter.com/widgets.js';
            script.async = true;
            document.head.appendChild(script);
        }

        const renderTweet = () => {
            if (window.twttr && window.twttr.widgets && containerRef) {
                containerRef.innerHTML = '';
                window.twttr.widgets.createTweet(
                    props.tweetId,
                    containerRef,
                    {
                        theme: 'light',
                        lang: 'zh-cn',
                        dnt: true,
                        conversation: 'none',
                        cards: 'visible',
                        width: 'auto',
                        align: 'center'
                    }
                ).then((el: any) => {
                    if (el) setIsLoaded(true);
                    else containerRef!.innerHTML = `<div style="color:#ccc; font-size:11px; padding:10px; text-align:center;">Tweet unavailable</div>`;
                });
            } else {
                setTimeout(renderTweet, 200);
            }
        };
        renderTweet();
    });

    return (
        <div
            class="tweet-embed-wrapper"
            style={{
                "min-height": isLoaded() ? "auto" : "150px",
                "width": "100%",
                "background": isLoaded() ? "transparent" : "#f8f9fa",
                "border-radius": "8px",
                "display": "flex",
                "justify-content": "center",
                "align-items": "center",
                "margin-top": "8px",
                "border": isLoaded() ? "none" : "1px dashed #e1e4e8"
            }}
        >
            <div ref={containerRef} style={{ width: '100%', display: 'flex', justifyContent: 'center' }}>
                <span style={{ color: '#aaa', fontSize: '11px' }}>Loading Tweet...</span>
            </div>
        </div>
    );

};

// --- å¡ç‰‡ç»„ä»¶ ---
const MemeCard: Component<MemeCardProps> = (props) => {
    const { item } = props;
    const cleanTwitterId = createMemo(() => extractTweetId(item.twitterId || item.twitter));
    const iconUrl = item.icon ? `${BACKEND_URL}/image-proxy?url=${encodeURIComponent(item.icon)}` : '';

    // âœ¨ è®¡ç®—å‘å°„è€—æ—¶
    const bondingSpeed = createMemo(() => getBondingDuration(item));

    const handleCardClick = () => {
        window.open(`/token.html?address=${item.contractAddress}&chain=${item.chain}`, '_blank');
    };

    const handleContentClick = (e: MouseEvent) => e.stopPropagation();

    const formattedCap = () => {
        if (!item.marketCap) return '-';
        if (item.marketCap >= 1000000) return (item.marketCap / 1000000).toFixed(1) + 'M';
        if (item.marketCap >= 1000) return (item.marketCap / 1000).toFixed(1) + 'K';
        return item.marketCap.toString();
    };

    return (
        <div class="meme-card" onClick={handleCardClick}>
            {/* Header */}
            <div class="card-header-layout">
                <Show when={item.icon} fallback={<div style={{ width: '42px', height: '42px', background: '#eee', borderRadius: '50%' }}></div>}>
                    <img src={iconUrl} class="card-icon" loading="lazy" onError={(e) => e.currentTarget.style.display = 'none'} />
                </Show>

                <div class="card-info-col">
                    <div class="info-row-top">
                        <div style={{display:'flex', alignItems:'center', gap: '6px', maxWidth: '180px'}}>
                            <span class="card-symbol" title={item.symbol}>{item.symbol}</span>
                            
                            {/* âœ¨ 1. ä»˜è´¹æ¨å¹¿é‡‘æ ‡ (å¼ºåŠ›çœ‹æ¶¨ä¿¡å·) */}
                            <Show when={item.paidOnDexScreener}>
                                <span title="Paid AD on DexScreener" style={{ fontSize: '0.6em', background: '#ffd700', color: '#856404', padding: '1px 3px', borderRadius: '3px', border: '1px solid #ffeeba', fontWeight: 'bold' }}>
                                    AD
                                </span>
                            </Show>
                        </div>
                        
                        <div style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>
                            {/* âœ¨ 2. å‘å°„é€Ÿåº¦å¾½ç«  (FOMO æŒ‡æ ‡) */}
                            <Show when={bondingSpeed()}>
                                <span style={{ 
                                    fontSize: '0.7em', 
                                    color: bondingSpeed()!.color, 
                                    fontWeight: 'bold', 
                                    display: 'flex', 
                                    alignItems: 'center',
                                    background: `${bondingSpeed()!.color}15`, // 10% opacity bg
                                    padding: '1px 5px',
                                    borderRadius: '4px'
                                }} title="ä»å‘å¸åˆ°è¿ç§»çš„è€—æ—¶">
                                    {bondingSpeed()!.icon} {bondingSpeed()!.text}
                                </span>
                            </Show>
                            {/* æ˜¾ç¤ºå…·ä½“çš„è¿ç§»å®Œæˆæ—¶é—´ */}
                            <span class="card-time">{formatTime(item.migrateTime || item.createTime || Date.now())}</span>
                        </div>
                    </div>

                    <div class="info-row-bottom">
                        <span class="stat-badge badge-cap">${formattedCap()}</span>
                        
                        {/* âœ¨ 3. ä¹°å–å•åŠ›åº¦ (æƒ…ç»ªæŒ‡æ ‡) */}
                        <Show when={item.countBuy !== undefined && item.countSell !== undefined}>
                             <span class="stat-badge" title={`Buys: ${item.countBuy} / Sells: ${item.countSell}`}>
                                <span style={{color: '#28a745', fontWeight: 'bold'}}>{item.countBuy}</span>
                                <span style={{opacity: 0.3, margin: '0 2px'}}>/</span>
                                <span style={{color: '#dc3545', fontWeight: 'bold'}}>{item.countSell}</span>
                             </span>
                        </Show>

                        <span class="stat-badge">ğŸ‘¥ {item.holders || '-'}</span>

                        {/* âœ¨ 4. ç‹™å‡»æ‰‹è­¦å‘Š (é£é™©æŒ‡æ ‡) */}
                        <Show when={(item.holdersSniperPercent || 0) > 50}>
                             <span class="stat-badge" style={{ background: '#fff5f5', color: '#e03131', borderColor: '#ffc9c9' }} title={`Sniper Holdings: ${item.holdersSniperPercent}%`}>
                                ğŸ¯ {Math.round(item.holdersSniperPercent!)}%
                             </span>
                        </Show>

                        <Show when={(item.devMigrateCount || 0) > 0}>
                            <span class="stat-badge badge-dev">Dev:{item.devMigrateCount}</span>
                        </Show>
                    </div>
                </div>
            </div>

            {/* Narrative */}
            <Show when={item.narrative}>
                <div class="card-narrative-box" onClick={handleContentClick}>
                    {item.narrative}
                </div>
            </Show>

            {/* Tweet */}
            <Show when={cleanTwitterId()}>
                <div onClick={handleContentClick} style={{ width: '100%', overflow: 'hidden' }}>
                    <TweetEmbed tweetId={cleanTwitterId()!} />
                </div>
            </Show>

            {/* Bonding Curve */}
            <div class="card-bonding-line" title={`Bonding Curve: ${item.progress?.toFixed(1)}%`}>
                <div
                    class="bonding-fill"
                    style={{
                        width: `${Math.min(item.progress || 0, 100)}%`,
                        "background-color": (item.progress || 0) > 90 ? '#28a745' : '#007bff'
                    }}
                ></div>
            </div>
        </div>
    );

};

// --- Column ---
const MemeColumn: Component<ColumnProps> = (props) => {
    return (
        <div class="meme-column">
            <div class="column-header">
                <span>{props.title}</span>
                <span class="column-badge" style={{ background: '#dce4ea', padding: '2px 8px', borderRadius: '10px', fontSize: '0.85em' }}>
                    {props.count}
                </span>
            </div>
            <div class="column-content">
                <For each={props.items}>
                    {(item) => <MemeCard item={item} />}
                </For>
                <Show when={props.items.length === 0}>
                    <div style={{ textAlign: 'center', padding: '50px 0', color: '#999', fontSize: '0.9em', gridColumn: '1 / -1' }}>
                        Waiting for data...
                    </div>
                </Show>
            </div>
        </div>
    );
};

// --- Page ---
const MemePage: Component = () => {
    // ç›‘å¬å·²è¿ç§»çš„ Meme æ•°æ®
    const {
        marketData: migratedMemeData,
        connectionStatus: migratedStatus,
        lastUpdate
    } = useMarketData<MemeItem>('meme_migrated');

    const migratedTokens = createMemo(() => {
        // âœ¨ æŒ‰è¿ç§»æ—¶é—´å€’åºï¼Œç¡®ä¿æœ€æ–°çš„é‡‘ç‹—åœ¨æœ€ä¸Šé¢
        const sorted = migratedMemeData
            .slice()
            .sort((a, b) => (b.migrateTime || 0) - (a.migrateTime || 0));
        
        if (sorted.length > 0) {
            console.log(`[MemePage] ğŸ¦‹ Top Token: ${sorted[0].symbol}, Migrated At: ${new Date(sorted[0].migrateTime!).toLocaleTimeString()}`);
        }
        return sorted;
    });

    onMount(() => console.log('[MemePage] ğŸš€ Migrated-Only Layout Mounted.'));

    return (
        <div class="meme-board-container">
            <header class="meme-header">
                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                    <h1>ğŸ¶ Meme Rush <span style={{ fontSize: '0.6em', color: '#999', fontWeight: 'normal' }}>KANBAN</span></h1>
                    <nav class="nav-links" style={{ display: 'flex', gap: '10px' }}>
                        <a href="/" class="nav-btn" style={{ textDecoration: 'none', color: '#666', fontSize: '0.9rem' }}>ğŸ”¥ Hotlist</a>
                        <span class="nav-btn active" style={{ fontWeight: 'bold', color: '#007bff', background: '#e7f1ff', padding: '4px 10px', borderRadius: '4px', fontSize: '0.9rem' }}>å·²å‘å°„çœ‹æ¿</span>
                    </nav>
                </div>
                <div style={{ display: 'flex', gap: '15px', alignItems: 'center', fontSize: '0.85em', color: '#666' }}>
                    <div>â± {lastUpdate()}</div>
                    <div class="status-indicator" title="Migrated Tokens Feed">
                        <span style={{
                            display: 'inline-block', width: '8px', height: '8px', borderRadius: '50%',
                            background: migratedStatus().includes('Connected') ? '#28a745' : '#dc3545',
                            marginRight: '4px'
                        }}></span>
                        {migratedStatus()}
                    </div>
                </div>
            </header>

            <div class="meme-board-grid">
                <MemeColumn title="ğŸ¦‹ å·²å‘å°„/é‡‘ç‹— (Migrated)" items={migratedTokens()} count={migratedTokens().length} />
            </div>
        </div>
    );

};

export default MemePage;